<?xml version="1.0" encoding="UTF-8"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro" name="SpotMicroAI">

   <xacro:include filename="$(find spotmicro_description)/urdf/include/inertias.urdf.xacro"/>
   <xacro:include filename="$(find spotmicro_description)/urdf/include/properties.urdf.xacro"/>

   <!-- Macros -->
   <xacro:macro name="gen_shoulder" params="name left">
      <link name="${name}">
         <visual>
            <xacro:if value="${left}">
               <geometry>
                  <mesh filename="package://spotmicro_description/meshes/stl/lshoulder.stl" scale="0.001 0.001 0.001" />
               </geometry>
               <origin rpy="0 0 3.1416" xyz="0.135 0.0163 -0.0195" />
            </xacro:if>
            <xacro:unless value="${left}">
               <geometry>
                  <mesh filename="package://spotmicro_description/meshes/stl/rshoulder.stl" scale="0.001 0.001 0.001" />
               </geometry>
               <origin rpy="0 0 3.1416" xyz="0.135 0.0938 -0.0205" />
            </xacro:unless>
            <material name="black" />
         </visual>
         <collision>
            <geometry>
               <box size="${shoulder_length} ${shoulder_width} ${body_height}" />
            </geometry>
         </collision>
         <xacro:inertial_cuboid mass="${shoulder_mass}" x_length="${shoulder_length}" y_length="${shoulder_width}" z_length="${body_height}"/>
      </link>
   </xacro:macro>
   <xacro:macro name="gen_shoulder_joint" params="pos shiftx shifty">
      <joint name="${pos}_shoulder" type="revolute">
         <parent link="base_link" />
         <child link="${pos}_shoulder_link" />
         <axis xyz="1 0 0" />
         <origin rpy="0 0 0" xyz="${shiftx} ${shifty} 0" />
         <limit effort="25.0" velocity="1.5" lower="-0.548" upper="0.548"/>
      </joint>
      <transmission name="${pos}_shoulder_trans">
         <type>transmission_interface/SimpleTransmission</type>
         <joint name="${pos}_shoulder">
               <hardwareInterface>hardware_interface/PositionJointInterface</hardwareInterface>
         </joint>
         <actuator name="${pos}_shoulder_actuator">
               <hardwareInterface>hardware_interface/PositionJointInterface</hardwareInterface>
               <mechanicalReduction>1</mechanicalReduction>
         </actuator>
      </transmission>
   </xacro:macro>
   <xacro:macro name="gen_leg" params="name left">
      <link name="${name}">
         <visual>
            <xacro:if value="${left}">
               <geometry>
                  <mesh filename="package://spotmicro_description/meshes/stl/larm.stl" scale="0.001 0.001 0.001" />
               </geometry>
               <origin rpy="0 0 3.1416" xyz="0.134 -0.04 -0.0095" />
            </xacro:if>
            <xacro:unless value="${left}">
               <geometry>
                  <mesh filename="package://spotmicro_description/meshes/stl/rarm.stl" scale="0.001 0.001 0.001" />
               </geometry>
               <origin rpy="0 0 3.1416" xyz="0.134 0.149 -0.0095" />
            </xacro:unless>
            <material name="black" />
         </visual>
         <!-- Visual cover -->
         <visual>
            <xacro:if value="${left}">
               <geometry>
                  <mesh filename="package://spotmicro_description/meshes/stl/larm_cover.stl" scale="0.001 0.001 0.001" />
               </geometry>
               <origin rpy="0 0 3.1416" xyz="0.134 -0.04 -0.0095" />
            </xacro:if>
            <xacro:unless value="${left}">
               <geometry>
                  <mesh filename="package://spotmicro_description/meshes/stl/rarm_cover.stl" scale="0.001 0.001 0.001" />
               </geometry>
               <origin rpy="0 0 3.1416" xyz="0.134 0.149 -0.0095" />
            </xacro:unless>
            <material name="yellow" />
         </visual>
         <collision>
            <origin xyz="0 0 -0.050" />
            <geometry>
               <box size="${leg_width} ${leg_height} ${leg_length}" />
            </geometry>
         </collision>
         <xacro:inertial_cuboid_with_pose mass="${leg_mass}" x_length="${leg_width}" y_length="${leg_height}" z_length="${leg_length}">
            <origin xyz="0 0 -0.050" />
         </xacro:inertial_cuboid_with_pose>
      </link>
      <gazebo reference="${name}">
         <kp>1000000.0</kp>
         <kd>1.0</kd>
         <mu1>0.8</mu1>
         <mu2>0.8</mu2>
         <maxVel>0.0</maxVel>
         <minDepth>0.001</minDepth>
      </gazebo>
   </xacro:macro>
   <xacro:macro name="gen_leg_joint" params="pos shift">
      <joint name="${pos}_leg" type="revolute">
         <parent link="${pos}_shoulder_link" />
         <child link="${pos}_leg_link" />
         <axis xyz="0 1 0" />
         <origin xyz="0 ${shift} 0" />
         <limit effort="25.0" velocity="1.5" lower="-2.666" upper="1.548"/>
      </joint>
      <transmission name="${pos}_leg_trans">
         <type>transmission_interface/SimpleTransmission</type>
         <joint name="${pos}_leg">
               <hardwareInterface>hardware_interface/PositionJointInterface</hardwareInterface>
         </joint>
         <actuator name="${pos}_leg_actuator">
               <hardwareInterface>hardware_interface/PositionJointInterface</hardwareInterface>
               <mechanicalReduction>1</mechanicalReduction>
         </actuator>
      </transmission>
   </xacro:macro>
   <xacro:macro name="gen_foot" params="name left">
      <link name="${name}">
         <visual>
            <xacro:if value="${left}">
               <geometry>
                  <mesh filename="package://spotmicro_description/meshes/stl/lfoot.stl" scale="0.001 0.001 0.001" />
               </geometry>
               <origin rpy="0 0 3.1416 " xyz="0.1195 -0.04 0.099" />
            </xacro:if>
            <xacro:unless value="${left}">
               <geometry>
                  <mesh filename="package://spotmicro_description/meshes/stl/rfoot.stl" scale="0.001 0.001 0.001" />
               </geometry>
               <origin rpy="0 0 3.1416" xyz="0.1195 0.149 0.099" />
            </xacro:unless>
            <material name="black" />
         </visual>
         <collision>
            <geometry>
               <box size="${foot_height} ${foot_width} ${foot_length}" />
            </geometry>
            <origin xyz="0 0 -0.050" />
         </collision>
         <xacro:inertial_cuboid_with_pose mass="${foot_mass}" x_length="${foot_height}" y_length="${foot_width}" z_length="${foot_length}">
            <origin xyz="0 0 -0.050" />
         </xacro:inertial_cuboid_with_pose>
      </link>
   </xacro:macro>
   <xacro:macro name="gen_foot_joint" params="pos">
      <joint name="${pos}_foot" type="revolute">
         <parent link="${pos}_leg_link" />
         <child link="${pos}_foot_link" />
         <axis xyz="0 1 0" />
         <origin rpy="0 0 0" xyz="0.014 0 -${leg_length}" />
         <limit effort="25.0" velocity="1.5" lower="-2.59" upper="0.1"/>
      </joint>
      <transmission name="${pos}_foot_trans">
         <type>transmission_interface/SimpleTransmission</type>
         <joint name="${pos}_foot">
               <hardwareInterface>hardware_interface/PositionJointInterface</hardwareInterface>
         </joint>
         <actuator name="${pos}_foot_actuator">
               <hardwareInterface>hardware_interface/PositionJointInterface</hardwareInterface>
               <mechanicalReduction>1</mechanicalReduction>
         </actuator>
      </transmission>
   </xacro:macro>
   <xacro:macro name="gen_toe" params="name">
      <link name="${name}">
         <visual>
            <geometry>
               <mesh filename="package://spotmicro_description/meshes/stl/foot.stl" scale="0.001 0.001 0.001" />
            </geometry>
            <origin rpy="0 0.40010 0" xyz="0 -0.01 0.015" />
            <material name="grey" />
         </visual>
         <collision>
            <geometry>
               <sphere radius="${toe_radius}" />
            </geometry>
         </collision>
         <xacro:inertial_sphere mass="${toe_mass}" diameter="${2*toe_radius}"/>
      </link>
      <gazebo reference="${name}">
         <kp>1000000.0</kp>
         <kd>1.0</kd>
         <mu1>1.0</mu1>
         <mu2>1.0</mu2>
         <maxVel>0.0</maxVel>
         <minDepth>0.001</minDepth>
      </gazebo>
   </xacro:macro>
   <xacro:macro name="gen_toe_joint" params="pos">
      <joint name="${pos}_toe" type="fixed">
         <parent link="${pos}_foot_link" />
         <child link="${pos}_toe_link" />
         <origin xyz="0 0 -0.13" />
      </joint>
   </xacro:macro>
   <xacro:macro name="gen_full_leg_joint" params="pos shiftx shifty shift left">
      <xacro:gen_shoulder name="${pos}_shoulder_link" left="${left}" />
      <xacro:gen_leg name="${pos}_leg_link" left="${left}" />
      <xacro:gen_foot name="${pos}_foot_link" left="${left}" />
      <xacro:gen_toe name="${pos}_toe_link" />
      <xacro:gen_shoulder_joint pos="${pos}" shiftx="${shiftx}" shifty="${shifty}" />
      <xacro:gen_leg_joint pos="${pos}" shift="${shift}" />
      <xacro:gen_foot_joint pos="${pos}" />
      <xacro:gen_toe_joint pos="${pos}" />
   </xacro:macro>
   <!-- Robot Body -->
   <link name="base_link"/>
   <link name="base_inertia">
      <visual>
         <geometry>
            <mesh filename="package://spotmicro_description/meshes/stl/mainbody.stl" scale="0.001 0.001 0.001" />
         </geometry>
         <material name="black" />
         <origin rpy="0 0 3.1416" xyz="0.0425 0.055 -0.02" />
      </visual>
      <collision>
         <geometry>
            <box size="${body_length} ${body_width} ${body_height}" />
         </geometry>
         <origin rpy="0 0 3.1416" />
      </collision>
      <xacro:inertial_cuboid mass="${body_mass}" x_length="${body_length}" y_length="${body_width}" z_length="${body_height}"/>
   </link>
   <joint name="base_link_to_base_inertia" type="fixed">
      <parent link="base_link" />
      <child link="base_inertia" />
   </joint>
   <link name="rear_link">
      <visual>
         <geometry>
            <mesh filename="package://spotmicro_description/meshes/stl/Cover_Rear_Plain.stl" scale="0.001 0.001 0.001" />
         </geometry>
         <origin rpy="0 1.57 0" xyz="-0.115 0 -0.006" />
         <material name="yellow" />
      </visual>
      <visual>
         <geometry>
            <mesh filename="package://spotmicro_description/meshes/stl/B_cover.stl" scale="0.001 0.001 0.001" />
         </geometry>
         <origin rpy="1.57 0 3.1416" xyz="0 0 -0.04" />
         <material name="yellow" />
      </visual>
      <collision>
         <geometry>
            <box size="${rear_length} ${body_width} ${body_height}" />
         </geometry>
         <origin xyz="-0.135 0 0" />
      </collision>
      <xacro:inertial_cuboid_with_pose mass="${rear_mass}" x_length="${rear_length}" y_length="${body_width}" z_length="${body_height}">
         <origin xyz="-0.135 0 0" />
      </xacro:inertial_cuboid_with_pose>
   </link>
   <joint name="base_rear" type="fixed">
      <parent link="base_link" />
      <child link="rear_link" />
   </joint>
   <gazebo reference="rear_link">
      <material>Gazebo/ZincYellow</material>
   </gazebo>
   <link name="front_link">
      <visual>
         <geometry>
            <mesh filename="package://spotmicro_description/meshes/stl/Cover_Nose_Realsense.STL" scale="0.001 0.001 0.001" />
         </geometry>
         <origin rpy="3.1416 0 0" xyz="0.13 -0.001 -0.01" />
         <material name="yellow" />
      </visual>
      <collision>
         <geometry>
            <box size="${front_length} ${body_width} ${body_height}" />
         </geometry>
         <origin xyz="0.135 0 0" />
      </collision>
      <xacro:inertial_cuboid_with_pose mass="${front_mass}" x_length="${front_length}" y_length="${body_width}" z_length="${body_height}">
         <origin xyz="0.135 0 0" />
      </xacro:inertial_cuboid_with_pose>
   </link>
   <gazebo reference="front_link">
      <material>Gazebo/ZincYellow</material>
   </gazebo>
   <joint name="base_front" type="fixed">
      <parent link="base_link" />
      <child link="front_link" />
   </joint>

   <!-- create Legs -->
   <xacro:gen_full_leg_joint pos="front_left" shiftx="${shiftx}" shifty="${shifty}" shift="${shift}" left="true" />
   <xacro:gen_full_leg_joint pos="front_right" shiftx="${shiftx}" shifty="-${shifty}" shift="-${shift}" left="false" />
   <xacro:gen_full_leg_joint pos="rear_left" shiftx="-${shiftx}" shifty="${shifty}" shift="${shift}" left="true" />
   <xacro:gen_full_leg_joint pos="rear_right" shiftx="-${shiftx}" shifty="-${shifty}" shift="-${shift}" left="false" />

   <!-- Accessories -->
   <xacro:include filename="$(find spotmicro_description)/urdf/accessories.urdf.xacro" />
   <xacro:accessories base_name="base_link"/>

   <gazebo>
      <plugin name="p3d_base_controller" filename="libgazebo_ros_p3d.so">
            <alwaysOn>true</alwaysOn>
            <updateRate>10.0</updateRate>
            <bodyName>base_link</bodyName>
            <topicName>odom/ground_truth</topicName>
            <gaussianNoise>0.01</gaussianNoise>
            <frameName>world</frameName>
            <xyzOffsets>0 0 0</xyzOffsets>
            <rpyOffsets>0 0 0</rpyOffsets>
        </plugin>
   </gazebo>

   <gazebo>
      <plugin name="gazebo_ros_control" filename="libgazebo_ros_control.so">
         <legacyModeNS>true</legacyModeNS>
      </plugin>
   </gazebo>

</robot>